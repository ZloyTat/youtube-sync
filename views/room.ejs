<!DOCTYPE html>
<html lang="en">
	<head>
	    <meta charset="utf-8">
	    <meta name="viewport" content="width=device-width, initial-scale=1">
		<link href="css/room.css" rel="stylesheet">

		<!--OPTIONAL "Raleway" font -->
		<link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet">

        <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
        <script src="js/socket.io.js"></script>
        <script>
            // Get the room code
            var roomCode = window.location.href.slice(-5)
            var socket = io("", { query: "roomCode="+roomCode });
        </script>
        <title><%=title%></title>
    </head>

    <body>
    	<div class="row" id="header">
    		<div class="col-1-6">
    			<div class="content">
                    
    			</div>
    		</div>
            <div class="col-5-6">
                <form id="link-submit">
                        <input type="text" placeholder="Enter a YouTube link" autocomplete="off" id="link-input">
                </form>
            </div>
    	</div>
        <div class="row" id="body-container">
            <div class="col-1-6" id="left-column">
                <div class="row" id="users-list-header">
                    0 users
                </div>
                <div class="row" id="users-column">
                    <div id="user-list"></div>
                </div>
            </div>
            <div class="col-5-8" id="main-area">
                <div class="row">
                    <!-- The <iframe> (and video player) will replace this <div> tag. -->
                    <div id="iframe-wrapper">
                        <div id="player"></div>
                    </div>

                    <script id="youtube-embed">
                        // This code loads the IFrame Player API code asynchronously.
                        var tag = document.createElement('script');

                        tag.src = "https://www.youtube.com/iframe_api";
                        var firstScriptTag = document.getElementById('youtube-embed');
                        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

                        var player;
                        function onYouTubeIframeAPIReady() {
                            
                            player = new YT.Player('player', {
                                height: '315',
                                width: '560',
                                videoId: 'blankVideo',
                                events: {
                                    'onReady': onPlayerReady,
                                    'onStateChange': onPlayerStateChange
                                }
                            });

                        }

                        function onPlayerReady(event) {
                            // Sets the video
                            socket.emit("set-video");
                            var previousTime = -1;
                            var interval = 1000;

                            // This function detects any "seek" events, then informs the server if it does happen
                            var checkTime = function(){
                                var currentTime = player.getCurrentTime();

                                if(previousTime > -1){
                                    if(Math.abs(currentTime - previousTime) > 2){
                                        socket.emit("seek-video", currentTime);
                                    }
                                }
                                previousTime = player.getCurrentTime();

                                // Updates the room's video time, so new clients joining the room will start at the correct time
                                socket.emit("update-room-time", currentTime);

                                if($('#video-title').html() != player.getVideoData().title){
                                    $('#video-title').text(player.getVideoData().title);
                                }
                                
                                setTimeout(checkTime, interval);
                            }

                            checkTime();
                        }
                        //    The API calls this function when the player's state changes.
                        //    The function indicates that when playing a video (state=1),
                        //    the player should play for six seconds and then stop.
                        function onPlayerStateChange(event) {
                            switch(event.data){
                                case YT.PlayerState.PAUSED:
                                    socket.emit("pause-player")
                                    break;
                                case YT.PlayerState.PLAYING:
                                    socket.emit("play-player");
                                    break;
                            }
                        }
                        function stopVideo() {
                            player.stopVideo();
                        }
                    </script>
                </div>
                <div class="row" id="video-info">
                    <div class="col-1-1">
                        <div class="content" id="video-title">
                            
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-custom" id="right-column">
                <div class="row" id="chat-header">
                    Live chat
                </div>
                <div class="row" id="chat-body">
                    <div id="messages"></div>
                </div>
                <div class="row" id="chat-submit-container">
                    <form id="chat-submit">
                        <input type="text" placeholder="Message" autocomplete="off" id="chat-input">
                    </form>
                </div>
            </div>
        </div>
        <div id="nameModal" class="modal">
            <div class="modal-content">
                <form id="name-submit">
                    <input type="text" placeholder="Enter your name to begin" autocomplete="off" id="name-input">
                </form>
            </div>
        </div>

        <script>
            var modal = document.getElementById("nameModal");
            var notificationSfx = new Audio('sfx/blop-sfx.mp3');

            var inputtedName;
            // Initial prompt for a new user asking for their name
            $('#name-submit').submit(function(){

                // Close the modal after they have submitted a name
                modal.style.display = "none";


                // Grab the string from the input field
                inputtedName = $("#name-input").val();

                socket.emit("new-user", {user : inputtedName, code : roomCode});
                return false;
            });

            // Sending a client-side message
            $('#chat-submit').submit(function(){

                var message = $("#chat-input").val();

                // Prevent entering blank messages
                if(message.length > 0){
                    socket.emit("chat-submit", {msg : message, code : roomCode, user : inputtedName});
                    $('#chat-input').val("");
                }

                return false;
            });

            // Submitting a YouTube link
            $('#link-submit').submit(function(){

                var videoId = $('#link-input').val().slice(-11);

                socket.emit("change-video", videoId);

                $('#link-input').val("");
                return false;
            })


            // Receiving a new message
            socket.on("update-messages", function(data){
                if(data.user.substring(0,1) === "â˜…")
                    $("#messages").append($('<div class="chat-message master">').html("<strong>" + data.user + ": </strong> " + data.msg));
                else
                $("#messages").append($('<div class="chat-message">').html("<strong>" + data.user + ": </strong> " + data.msg));
                notificationSfx.play();

                // Keep div scrolled to the bottom
                $("#chat-body").scrollTop($("#chat-body")[0].scrollHeight);
            });

            // Receiving an alert of a new connection
            socket.on("update-users", function(people){
                $("#user-list").html('');
                for(var i = 0; i < people.length; i++){
                    $("#user-list").append($('<div class="online-users">').text(people[i].name));
                }
                // User count update
                if(people.length == 1){
                    $('#users-list-header').text(people.length + " user");
                }
                else{
                    $('#users-list-header').text(people.length + " users");
                }
            });

            // Receiving an alert of someone connecting
            socket.on("connection-message", function(name){
                $("#messages").append($('<div class="chat-message leaver">').html("<strong>" + name + " has joined the room</strong>"));
            })

            // Receiving an alert of someone disconnecting
            socket.on("disconnection-message", function(name){
                $("#messages").append($('<div class="chat-message leaver">').html("<strong>" + name + " has left the room</strong>"));
            });

            
            // Pause the video when someone else in the room pauses
            socket.on("set-player-state-paused", function(){
                if(player.getPlayerState() != 2)
                    player.pauseVideo();
            });

            // Play the video when someone else in the room plays
            socket.on("set-player-state-play", function(){
                if(player.getPlayerState() != 1)
                    player.playVideo();
            });

            // Update the video if it changes
            socket.on("update-video", function(data){
                player.cueVideoById(data.videoId, data.currentTime);
            });

            // Update the video's time when someone seeks
            socket.on("update-currentTime", function(time){
                player.seekTo(time, true);
            })

            
        </script>
    </body>
</html>